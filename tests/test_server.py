from pathlib import Path
import pytest
from time import sleep
from typing import List, Dict
from subprocess import Popen
import os
import signal

import agent

URL = "http://127.0.0.1:5000"

test_cases = [
    ('tests/test_maze.png', {
        "XXXXXXXXXX":
            {
                "command_1": {
                    "name": "X",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 0, 0, 255, 0], " +
                        "[255, 255, 255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_2": {
                    "name": "X",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 0, 0, 255, 0], " +
                        "[255, 255, 255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_3": {
                    "name": "X",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 0, 0, 255, 0], " +
                        "[255, 255, 255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_4": {
                    "name": "X",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 0, 0, 255, 0], " +
                        "[255, 255, 255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_5": {
                    "name": "X",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 0, 0, 255, 0], " +
                        "[255, 255, 255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_6": {
                    "name": "X",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 0, 0, 255, 0], " +
                        "[255, 255, 255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_7": {
                    "name": "X",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 0, 0, 255, 0], " +
                        "[255, 255, 255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_8": {
                    "name": "X",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 0, 0, 255, 0], " +
                        "[255, 255, 255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_9": {
                    "name": "X",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 0, 0, 255, 0], " +
                        "[255, 255, 255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_10": {
                    "name": "X",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 255, 0, 255, 0], " +
                        "[0, 255, 0, 0, 0, 255, 0], " +
                        "[255, 255, 255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0, 0, 0]" +
                    "]"
                },
                "moves" : "10"
            },
        "xnEEeNNNNw":
            {
                "command_1": {
                    "name": "X",
                    "successful": "0",
                    "view": "[" + 
                        "[255, 0, 255, 0, 255], " +
                        "[255, 0, 0, 0, 255], " +
                        "[255, 255, 64, 255, 255], " +
                        "[0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_2": {
                    "name": "N",
                    "successful": "0",
                    "view": "[" + 
                        "[255, 0, 255, 0, 255], " +
                        "[255, 0, 0, 0, 255], " +
                        "[255, 255, 64, 255, 255], " +
                        "[0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_3": {
                    "name": "E",
                    "successful": "1",
                    "view": "[" + 
                        "[0, 255, 0, 255, 0], " +
                        "[0, 0, 0, 255, 0], " +
                        "[255, 64, 255, 255, 0], " +
                        "[0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_4": {
                    "name": "E",
                    "successful": "1",
                    "view": "[" + 
                        "[255, 0, 255, 0, 255], " +
                        "[0, 0, 255, 0, 255], " +
                        "[64, 255, 255, 0, 255], " +
                        "[0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_5": {
                    "name": "E",
                    "successful": "0",
                    "view": "[" + 
                        "[255, 0, 255, 0, 255], " +
                        "[0, 0, 255, 0, 255], " +
                        "[64, 255, 255, 0, 255], " +
                        "[0, 0, 0, 0, 0], " +
                        "[0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_6": {
                    "name": "N",
                    "successful": "1",
                    "view": "[" + 
                        "[255, 0, 255, 0, 0], " +
                        "[255, 0, 255, 0, 255], " +
                        "[0, 0, 255, 0, 255], " +
                        "[64, 255, 255, 0, 255], " +
                        "[0, 0, 0, 0, 0]" +
                    "]"
                },
                "command_7": {
                    "name": "N",
                    "successful": "1",
                    "view": "[" + 
                        "[255, 0, 255, 255, 255], " +
                        "[255, 0, 255, 0, 0], " +
                        "[255, 0, 255, 0, 255], " +
                        "[0, 0, 255, 0, 255], " +
                        "[64, 255, 255, 0, 255]" +
                    "]"
                },
                "command_8": {
                    "name": "N",
                    "successful": "1",
                    "view": "[" + 
                        "[255, 0, 0, 0, 255], " +
                        "[255, 0, 255, 255, 255], " +
                        "[255, 0, 255, 0, 0], " +
                        "[255, 0, 255, 0, 255], " +
                        "[0, 0, 255, 0, 255]" +
                    "]"
                },
                "command_9": {
                    "name": "N",
                    "successful": "1",
                    "view": "[" + 
                        "[255, 0, 255, 0, 255], " +
                        "[255, 0, 0, 0, 255], " +
                        "[255, 0, 255, 255, 255], " +
                        "[255, 0, 255, 0, 0], " +
                        "[255, 0, 255, 0, 255]" +
                    "]"
                },
                "command_10": {
                    "name": "W",
                    "successful": "0",
                    "view": "[" + 
                        "[255, 0, 255, 0, 255], " +
                        "[255, 0, 0, 0, 255], " +
                        "[255, 0, 255, 255, 255], " +
                        "[255, 0, 255, 0, 0], " +
                        "[255, 0, 255, 0, 255]" +
                    "]"
                },
                "moves": "6"
            }
    }),
    # ('test_maze.png', {

    # }),
]

@pytest.fixture
def start_server():
    server_lst: List[Popen] = []
    def _start(maze):
        server = Popen(['python3', 'app.py', '-m', str(maze)], stdin=None, stdout=None, stderr=None, close_fds=True)
        sleep(1)
        server_lst.append(server)
        return server
    
    yield _start

    server = server_lst[0]
    os.kill(server.pid, signal.SIGKILL)

@pytest.mark.parametrize("maze,commands", test_cases)
def test_server(start_server, maze, commands: Dict[str, dict]):
    start_server(maze)
    sleep(1)

    _, uuid, _ = agent.connect(None, None, URL, None)

    for comm_str, expected_resp in commands.items():
        correct_comm_str = comm_str.upper()

        received_resp = agent.send_commands(URL, uuid, correct_comm_str)

        for key, val in expected_resp.items():
            assert key in received_resp
            assert val == received_resp.pop(key)

        assert len(received_resp.items()) == 0
